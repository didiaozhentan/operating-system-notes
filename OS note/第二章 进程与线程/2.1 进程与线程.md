# 2.1.1进程的概念与特征
进程的定义:
- 是一个正在执行程序的实例
- 是一个程序及其数据从磁盘加载到内存后,在CPU上的执行过程
- 是一个具有独立功能的程序在一个数据集合上运行的过程


组织方式：链接方式，指针指向不同的队列；索引方式，索引表
特征：动态性、并发性、独立性、异步性、结构性

eg.QQ是一个程序,打开三次QQ就算有了三个进程
所谓创建进程,其实就是创建进程的PCB;撤销进程就是撤销进程的PCB

# 2.1.2进程的组成
## 进程控制块
PCB是进程存在的唯一标志

PCB的内容：
![[Pasted image 20250407143750.png]]
进程描述消息：
- 进程标识符：标志各个进程，每个进程都有一个唯一的标识号
- 用户标识符：进程所归属的用户，用户标识符主要为共享和保护服务
进程控制和管理消息：
- 进程当前状态
- 进程优先级
资源分配清单：
- 用于说明有关内存地址空间或虚拟地址空间的状态
处理机相关信息：
- 也就是CPU的上下文，当进程被切换时
## 程序段 & 数据段
程序可以被多个进程共享，即多个进程可以运行一个程序
进程的数据段，可以是进程对应的程序加工处理的原始数据，也可以是程序执行时产生的中间或最终结果

# 2.1.3进程的状态与转换

运行状态：占有CPU，并在CPU上运行，单核只能一个进程（双核两个）（CPU√，其它资源√）

就绪状态：已经具备运行条件，但是没有空闲的CPU，暂时不能运行（CPU×，其它资源√）

阻塞状态：等在某个事件的发生或I/O完成，暂时不能运行（CPU×，其它资源×）

创建状态：申请PCB并填入控制和管理进程的信息，为进程分配所需资源，进程转入就绪态并转入就绪队列。

终止状态：首先置为终止态，然后回收内存、程序段，数据段撤销PCB

![[Pasted image 20250410093544.png]]

创建态->就绪态

就绪态->运行态：获得CPU资源，从就绪态转为运行态

运行态->就绪态：运行态的进程在时间片用完后，让出CPU，运行态转就绪态。在可剥夺操作系统中，当有更高优先级的进程就绪时，调度程序使得运行态转就绪态

运行态->终止态：比如数组越界

运行态->阻塞态：请求某资源的使用和分配或等待某一事件的发生。是进程请求操作系统，是主动的。

阻塞态->就绪态：进程等待事件到了，如I/O操作完成或中断结束时，中断处理程序将相应进程的状态由阻塞转就绪，是被动的。

# 2.1.4进程控制

## 进程的创建

进程（*父进程*）可以创建另一个进程（*子进程*），子进程可以继承父进程所拥有的资源。
- 当子进程撤销时，返还资源给父进程。
- 当父进程撤销时，会撤销所有子进程

### 创建原语
- 分配进程标识号*PID*，申请一个空白PCB。若申请失败，则创建失败。
- 分配所需资源（*内存，文件，I/O，CPU时间等*）资源来自操作系统或者父进程。若资源不足，*不是创建失败*，而是除于创建态，等待资源。
- 初始化PCB，主要包括初始化标志信息，CPU状态信息，CPU控制信息，进程优先级等。

## 进程的终止

### 终止原语
- 根据标识符*PID*，找到PCB，读出进程状态
- 若进程除于运行态，立即终止进程的执行，将CPU资源释放
- 若进程有子进程，则将所有子进程终止
- 归还进程拥有的全部资源，归还给父进程或操作系统
- 将PCB从队列（链表）中删除

## 进程的阻塞和唤醒

### 阻塞原语
- 找到阻塞进程PID对应的PCB
- 若进程是运行态，则保护现场并转为阻塞态
- 将该PCB插入事件的等待队列，CPU资源调度给别的进程
### 唤醒原语
- 在事件的等待队列中找到进程的PCB
- 将其从等待队列中移出，把状态改为就绪态
- 将该PCB转入就绪队列，等待调度程序调度

注：block和wakeup原语必须成对使用

## 进程的通信
### 共享存储
互相通信的进程之间有一块可以直接访问的*共享空间*，通过对共享空间进行读写操作实现进程之间的信息交换。在进行读写操作时需要使用*同步互斥工具，如P/V操作*
共享存储分为：
- 基于数据结构的共享*低级*
- 基于存储区的共享*高级*
![[Pasted image 20250410100955.png]]

### 消息传递
进程间的数据交换以格式化的消息（*message*）为单位，通过操作系统提供的*发送信息*和*接收信息*两个原语进行数据交换。
消息传递分为：
- 直接通信方式：发送进程将消息发送给接受进程，并将它挂起在接收进程的消息缓冲队列。
- 间接通信方式：发送进程将消息发送到某个中间实体（*一般称为信箱*），接收进程从中间实体取得消息。

### 管道通信
管道是一个特殊的共享文件，又称pipe文件（*在内存中开辟大小固定的内存缓冲区*）数据在管道中是先进先出的。
只要管道不满，就可以写；只要管道不空，就可以读
互斥：一方读/写时，另一方等待
同步：写入一定量后写进程阻塞，等待读后唤醒；数据取空后读进程阻塞，等待写后唤醒
管道只允许创建进程所访问，子进程会继承父进程的管道，也可用来与父进程通信
![[Pasted image 20250410102232.png]]

# 2.1.6线程和多线程模型
## 线程的基本概念
线程是一个基本的CPU执行单元，可以理解为轻量级进程，也是程序执行流的最小单位，进一步提高了系统的并发度。

## 进程与线程的比较
- 调度：引入线程的操作系统中，线程是独立调度的基本单位
- 并发性：一个操作系统中的进程之间可以并发运行，一个进程中的线程也可以并发运行
- 拥有资源：进程是系统中拥有资源的基本单位，线程不拥有系统资源。线程可以访问隶属进程的系统资源
- 独立性：某个进程中的线程对其他进程不可见
- 系统开销：可以只在进程中切换，减小了CPU切换环境的系统开销
- 支持多处理机系统：多线程进程可以将多个线程分配到多个CPU上执行

## 线程的属性
- 线程是处理机调度的基本单位
- 多CPU计算机中，各个线程可占用不同的CPU
- 每个线程都有一个线程ID、线程控制块（TCB）
- 线程也有就绪、阻塞、运行三种基本状态
- 线程几乎不拥有系统资源（仅有必不可少保证运行的资源）
- 同一进程的不同线程间共享进程的资源
- 由于共享内存地址空间，统一进程中的线程间通信甚至无需系统干预
- 同一进程中的线程切换，不会引起进程切换
- 不同进程中的线程切换，会引起进程切换
- 切换同进程内的线程，系统开销很小
- 切换进程，系统开销较大
## 线程的组织和控制
### 线程控制块（TCB）
TCB包括：
- 线程标识符
- 一组寄存器，包括程序计数器、状态寄存器和通用寄存器
- 线程运行状态
- 优先级
- 线程专业存储区
- 堆栈指针

## 线程的实现方式
### 用户级线程（ULT）：

由应用管理，从用户的视角看能看到的线程。有关线程的所有工作都由应用程序在用户态完成。
*ULT的优点：*
- 线程切换不需要转换到内核空间，节省了模式切换的开学。
- 调度算法可以是进程专用的，毕竟灵活
- 线程的实现和操作系统无关，是在用户程序中管理
*ULT的缺点：*
- 线程被阻塞时，进程的其他所有线程都被阻塞
- 进程中仅有一个线程执行，不能发挥多CPU优势


### 内核级线程（KLT）：

由操作系统管理，从操作系统内核视角看能看到的线程。
*KLT的优点：*
- 能发挥多CPU的优势，可以多个线程并行执行
- 一个线程被阻塞可以调度同进程其他线程或其他进程的线程
- 数据结构和堆栈小，线程切换比较快、开销小
- 内核本身也是多线程，可以提高系统的执行速度和效率

*KLT的缺点：*
- 同进程的线程切换，需要用户态转内核态，系统开销大
- 以上是因为用户进程的线程在用户态运行，但线程调度和管理在内核实现

![[Pasted image 20250410230754.png]]

### 组合方式
结合二者特点

## 多线程模型
### 多对一： 
- 优点：线程管理在用户态进行，不用切换核心态，效率比较高
- 缺点：一个时刻只能有一个线程访问内核，且若发生阻塞进程都会被阻塞
### 一对一：
- 优点：一个线程阻塞可以调度别的线程
- 缺点：没创建一个用户线程，就要有一个内核线程，开销大
### 多对多：
- 特点：要求n>=m，结合了优点

![[Pasted image 20250410231716.png]]

## 小结（阅读）

### 为什么要引入进程?
在多道程序设计的背景下，进程之间需要共享系统资源，因此会导致各程序在执行过程中出现相互制约的关系，程序的执行会表现出间断性等特征。这些特征都是在程序的执行过程中发生的，是动态的过程，而传统的程序本身是一组指令的集合，是静态的概念，无法描述程序在内存中的执行情况，即无法从程序的字面上看出它何时执行、何时停顿，也无法看出它与其他执行程序的关系，因此，程序这个静态概念已不能如实反映程序并发执行过程的特征。为了深刻描述程序动态执行过程的性质乃至更好地支持和管理多道程序的并发执行，便引入了进程的概念。

### 什么是进程?进程由什么组成?
进程是一个具有独立功能的程序关于某个数据集合的一次运行活动。它可以申请和拥有系统资源，是一个动态的概念，是一个活动的实体。它不只是程序的代码本身，还包括当前的活动，通过程序计数器的值和处理寄存器的内容来表示。
一个进程实体由程序段、相关数据段和 PCB 三部分构成，其中 PCB 是标志一个进程存在的唯一标识，程序段是进程运行的程序的代码，数据段则存储程序运行过程中相关的一些数据。

### 进程是如何解决问题的?
进程将能够识别程序运行状态的一些变量存放在PCB 中，通过这些变量系统能够更好地了解进程的状况，并在适当时机进行进程的切换，以避免一些资源的浪费，甚至划分为更小的调度
单位--线程来提高系统的并发度。本节主要介绍什么是进程，并围绕这个问题进行一些阐述和讨论，为下一节讨论的内容做铺垫，但之前未学过相关课程的读者可能比较费解，到现在为止对进程这个概念还未形成比较清晰的认识。接下来，我们再用一个比较熟悉的概念来类比进程，以便大家能彻底理解本节的内容到底在讲什么，到底解决了什么问题。