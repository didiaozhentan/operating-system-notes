# 1.3.1处理机运行模式
CPU通常出来两种程序：操作系统内核程序和用户自编程序。其中内核程序会执行一些特权指令，用户程序不能执行特权指令。
*特权指令*：I/O指令、关中断指令、内存清零指令、存取受保护的寄存器指令、修改程序状态字寄存器指令等

CPU的运行模式分为*用户态*和*核心态*。应用程序想操作系统请求服务时，是通过*访管指令*，该指令是在用户态下执行的，是非特权指令。

操作系统内核：
1. 时钟管理：计时，时间片管理
2. 中断处理：目的是提高CPU的利用率
3. 原语：在*底层*用来被调用的小程序，具有*原子性*，运行*时间短*，会被频繁调用
4. 系统控制的数据结构：作业控制块，进程控制块，缓冲区，消息队列等等

# 1.3.2中断和异常
## 概念
中断也称*外中断*，来自CPU外部的事件，如设备发出的I/O结束中断，时钟中断。
异常也称*内中断*，来自CPU内部的事件，如地址越界，运算溢出等
异常不能被屏蔽，一旦出现，应该立即处理。

中断：
- 可屏蔽中断：可通过改变屏蔽字实现多重中断
- 不可屏蔽中断：紧急的硬件故障，如电源断电
异常:
- 故障：是由指令执行引起，如非法操作码、缺页故障
- 自陷：事先安排好的异常，如条件陷进指令
- 终止：也是硬件故障，如控制器出错，存储器校验错

## 处理过程
正常执行过程中遇到异常事件，会打断当前的用户程序，转到对应的中断/异常处理程序，若成功解决则返回用户程序，若失败则终止用户程序。

# 1.3.3系统调用
概念：应用程序通过系统调用请求操作系统的服务。保证系统的稳定性和安全性。

系统调用和库函数的区别：
- 系统调用是操作系统向上层提供的接口
- 有的库函数是对系统调用的进一步封装
- 当今编写的应用程序大多是通过高级语言提供的库函数间接地进行系统调用

系统调用的处理过程：
- 第一步，用户程序首先将系统调用号和所需的参数压入堆栈；接着，调用实际的调用指令，然后执行一个*陷入指令*，将CPU状态从用户态转为内核态，再后由硬件和操作系统内核程序保护被中断进程的现场，将程序计数器（PC）、程序状态字（PSW）及通用寄存器内容等压入堆栈。
- 第二步，分析系统调用类型，转入相应的系统调用处理子程序。在系统中配置了一张系统调用入口表，表中的每个表项都对应一个系统调用，根据系统调用号可以找到该系统调用处理子程序的入口地址。
- 第三步，在系统调用处理子程序执行结束后，恢复被中断的或设置新进程的CPU现场，然后返回被中断进程或新进程，继续往下执行。

![[Pasted image 20250404151659.png]]